import{r as a,j as e,C as J,R as E}from"./index-C6UZZE1B.js";import{g as $,r as k,l as te,b as se,a as ae,d as le,u as ne}from"./index.esm2017-6eeVvdOw.js";import{d as oe,h as ie,D as L,v as K,a as U,e as re}from"./database-CL0enfGk.js";import{d as X,a as D,c as V}from"./index.esm-CaOeY0Rr.js";import{C as G,a as z,b as B,c as H,d as Y}from"./CModalTitle-DyJ8safq.js";import{d as _,b as Q,c as F,C as ce,a as q}from"./CRow-BOoGTJLM.js";import{C as de}from"./CAlert-D5MWXatH.js";import"./CConditionalPortal-BWtFwqv2.js";import"./CCloseButton-B3bq1kyM.js";import"./DefaultLayout-LzP_z8e3.js";var ue=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M334.627,16H48V496H472V153.373ZM440,166.627V168H320V48h1.373ZM80,464V48H288V200H440V464Z' class='ci-primary'/>"],me=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M479.6,399.716l-81.084-81.084-62.368-25.767A175.014,175.014,0,0,0,368,192c0-97.047-78.953-176-176-176S16,94.953,16,192,94.953,368,192,368a175.034,175.034,0,0,0,101.619-32.377l25.7,62.2L400.4,478.911a56,56,0,1,0,79.2-79.195ZM48,192c0-79.4,64.6-144,144-144s144,64.6,144,144S271.4,336,192,336,48,271.4,48,192ZM456.971,456.284a24.028,24.028,0,0,1-33.942,0l-76.572-76.572-23.894-57.835L380.4,345.771l76.573,76.572A24.028,24.028,0,0,1,456.971,456.284Z' class='ci-primary'/>"];const he=()=>{const[A,f]=a.useState([]),[b,u]=a.useState(!0),[s,N]=a.useState(null),[j,p]=a.useState(!1);a.useEffect(()=>{(async()=>{try{const r=await new L().getClients();console.log("Fetched clients:",r.length);const t=$(),o=r.map(async d=>{const x=d.cid,I=k(t,`${K.FIRESTORE_ACTIVE_USERS_COLLECTION}/${x}/`);try{const v=await te(I);if(v.items.length===0)return[];const M=v.items.map(async P=>{const R=await se(P),O=await ae(P);return{clientName:`${d.firstName} ${d.lastName}`,documentTitle:R.name,dateAdded:R.timeCreated,downloadURL:O,storagePath:P.fullPath}});return await Promise.all(M)}catch(v){return console.error(`Error fetching documents for CID ${x}:`,v),[]}}),c=(await Promise.all(o)).flat();c.sort((d,x)=>new Date(x.dateAdded).getTime()-new Date(d.dateAdded).getTime()),console.log("Total documents fetched:",c.length),console.log("Documents:",c),f(c),u(!1)}catch(S){console.error("Error fetching documents:",S),u(!1)}})()},[]);const m=l=>{N(l),p(!0)},C=async l=>{if(window.confirm(`Are you sure you want to delete ${l.documentTitle}?`))try{const r=$(),t=k(r,l.storagePath);await le(t),f(o=>o.filter(n=>n.storagePath!==l.storagePath)),alert("File deleted successfully.")}catch(r){console.error("Error deleting file:",r),alert("Failed to delete the file.")}};if(b)return e.jsx("div",{className:"text-center",children:e.jsx(J,{color:"primary"})});const g=[{key:"clientName",label:"Client",_style:{width:"20%"}},{key:"documentTitle",label:"Document Title",_style:{width:"40%"}},{key:"dateAdded",label:"Date Added",_style:{width:"15%"},sorter:!0},{key:"actions",label:"Quick Actions",_style:{width:"10%"},filter:!1}],w=A.map(l=>({...l,dateAdded:new Date(l.dateAdded).toLocaleDateString()}));return console.log("Items to display:",w),e.jsxs(X,{children:[e.jsx(oe,{items:w,columns:g,columnSorter:!0,columnFilter:!0,itemsPerPage:50,pagination:!0,scopedColumns:{actions:l=>e.jsxs("td",{children:[e.jsx(D,{color:"info",variant:"ghost",size:"sm",className:"mr-2",onClick:()=>m(l),children:e.jsx(V,{icon:me,size:"lg"})}),e.jsx(D,{color:"danger",variant:"ghost",size:"sm",onClick:()=>C(l),children:e.jsx(V,{icon:ie,size:"lg"})})]})},tableProps:{striped:!0,hover:!0}}),e.jsxs(G,{size:"xl",visible:j,onClose:()=>p(!1),children:[e.jsx(z,{closeButton:!0,children:e.jsx(B,{children:s==null?void 0:s.documentTitle})}),e.jsx(H,{children:s&&e.jsx("iframe",{src:s.downloadURL,title:"Document Preview",style:{width:"100%",height:"80vh"}})})]})]})},fe=({visible:A,onClose:f,onUploadSuccess:b})=>{const u=new L,[s,N]=a.useState(""),[j,p]=a.useState([]),[m,C]=a.useState([]),[g,w]=a.useState(""),[l,S]=a.useState([]),[r,t]=a.useState(!1),[o,n]=a.useState(!0),[c,d]=a.useState({}),[x,I]=a.useState(null),[v,M]=a.useState(null);a.useEffect(()=>{(async()=>{const h=await u.getClients();p(h),C(h)})()},[]),a.useEffect(()=>{const i=j.filter(h=>{var y;return(((y=h.firstName)==null?void 0:y.toLowerCase().includes(s.toLowerCase()))||h.lastName.toLowerCase().includes(s.toLowerCase()))??!1});C(i)},[s,j]);const Z=j.map(i=>({label:`${i.firstName} ${i.lastName}`,value:i.cid})),P=async i=>{const h=i.slice(0,1);if(h.length===0)I(await u.getClient(c.parentDocId??""));else{const y=h[0].label,T=h[0].value;console.log(T),I(await u.getClient(T)??await u.getClient(c.parentDocId??"")),o&&d({...c,recipient:y})}},R=async()=>{if(!x||!x.cid){M("Please select a client.");return}if(l.length===0){M("Please select at least one file.");return}M(null),await W()},O=i=>{i.target.files&&S(Array.from(i.target.files))},W=async()=>{if(!x||!x.cid){console.error("No client selected.");return}if(l.length===0){console.error("No files to upload.");return}t(!0);const i=x.cid,h=l.map(y=>{const T=`${K.FIRESTORE_ACTIVE_USERS_COLLECTION}/${i}/${y.name}`;console.log(`Uploading file to: ${T}`);const ee=k($(),T);return ne(ee,y)});try{await Promise.all(h),console.log("All files uploaded successfully."),b(),S([])}catch(y){console.error("Error uploading files:",y)}finally{t(!1)}};return e.jsxs(G,{visible:A,onClose:f,size:"lg",alignment:"center",children:[e.jsx(z,{closeButton:!0,children:e.jsx(B,{children:"Add Statement"})}),e.jsxs(H,{children:[e.jsx(U,{options:Z,onChange:P,placeholder:"Select Client",multiple:!1}),e.jsxs("div",{className:"mb-3 mt-3",children:[" ",e.jsx(_,{type:"file",accept:".pdf",multiple:!0,onChange:O}),l.length>0&&e.jsxs("div",{style:{marginTop:"10px"},children:[e.jsx("strong",{children:"Selected files:"}),e.jsx("ul",{children:l.map(i=>e.jsx("li",{children:i.name},i.name))})]})]}),v&&e.jsx(de,{color:"danger",children:v})]}),e.jsxs(Y,{children:[e.jsx(D,{color:"secondary",onClick:f,disabled:r,children:"Cancel"}),e.jsx(D,{color:"primary",onClick:R,disabled:r,children:r?"Uploading...":"Upload"})]})]})},pe=({showModal:A,setShowModal:f,clientOptions:b})=>{const u=new L,[s,N]=E.useState(null),[j,p]=E.useState("Cumulative"),[m,C]=E.useState(null),[g,w]=E.useState(null),[l,S]=E.useState(!1),r=a.useMemo(()=>{if(!s)return[{label:"Cumulative",value:"Cumulative"}];let t=new Set;t.add("Cumulative");for(const n in s.assets)for(const c in s.assets[n]){const d=s.assets[n][c].displayTitle;d==="Personal"?t.add(`${s.firstName} ${s.lastName}`):t.add(d)}return[...t].map(n=>({label:n,value:n}))},[s]);return e.jsxs(G,{visible:A,onClose:()=>f(!1),size:"lg",alignment:"center",children:[e.jsx(z,{closeButton:!0,children:e.jsx(B,{children:"Generate Statement"})}),e.jsx(H,{children:e.jsxs(e.Fragment,{children:[e.jsxs(Q,{className:"mb-3 w-100",children:[e.jsx(F,{children:"Client"}),e.jsx(U,{id:"client",className:"flex-grow-1",style:{minWidth:0},options:b,defaultValue:s==null?void 0:s.cid,placeholder:"Select Client",selectAll:!1,multiple:!1,allowCreateOptions:!1,onChange:async t=>{if(t.length===0)return;const o=t[0].value,n=await u.getClient(o);n&&N(n)}}),e.jsx(F,{children:"Account"}),e.jsx(U,{id:"recipient",className:"flex-grow-1",style:{minWidth:0},options:r,defaultValue:"Cumulative",placeholder:"Select Recipient",multiple:!1,onChange:t=>{var n;const o=((n=t[0])==null?void 0:n.value)||"";p(o)}})]}),e.jsxs(Q,{className:"mb-3",children:[e.jsx(F,{children:"Start Date"}),e.jsx(_,{type:"date",onChange:t=>{const o=t.target.value;if(o){const[n,c,d]=o.split("-").map(Number);C(new Date(n,c-1,d))}else C(null)}}),e.jsx(F,{children:"End Date"}),e.jsx(_,{type:"date",onChange:t=>{const o=t.target.value;if(o){const[n,c,d]=o.split("-").map(Number);w(new Date(n,c-1,d,23,59,59,999))}else w(null)}})]}),m&&g&&m>g&&e.jsx("div",{className:"text-danger mt-2",children:"Start date must be before end date."})]})}),e.jsxs(Y,{children:[e.jsx(D,{color:"secondary",onClick:()=>f(!1),children:"Cancel"}),e.jsx(re,{color:"primary",onClick:async()=>{const t=new L;S(!0),await t.generateStatementPDF(s,m,g,j),S(!1)},loading:l,disabled:!s||!m||!g||m>g,children:"Generate"})]})]})},Ae=()=>{const[A,f]=a.useState([]),[b,u]=a.useState([]),[s,N]=a.useState(!0),[j,p]=a.useState(!1),[m,C]=a.useState(!1),g=()=>{p(!1)},w=()=>{p(!1),window.location.reload()};return a.useEffect(()=>{(async()=>{const r=await new L().getClients();u(r.map(t=>({value:t.cid,label:t.firstName+" "+t.lastName})).sort((t,o)=>t.label.localeCompare(o.label))),f(r),N(!1)})()},[]),s?e.jsx("div",{className:"text-center",children:e.jsx(J,{color:"primary"})}):e.jsxs(X,{children:[e.jsxs(ce,{className:"mb-3 mx-1",children:[e.jsx(q,{children:e.jsx(D,{color:"primary",onClick:()=>p(!0),className:"w-100",children:"+ Add Statement"})}),e.jsx(q,{children:e.jsxs(D,{color:"info",onClick:()=>C(!0),className:"w-100 d-flex align-items-center justify-content-center",children:[e.jsx(V,{icon:ue,className:"me-2"}),"Generate Statement"]})})]}),e.jsx(fe,{visible:j,onClose:g,onUploadSuccess:w}),m&&e.jsx(pe,{showModal:m,setShowModal:C,clientOptions:b}),e.jsx(he,{})]})};export{Ae as default};
